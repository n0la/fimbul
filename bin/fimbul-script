#!/usr/bin/lua

local pretty = require("pl.pretty")
local std = require("std")

local util = require("fimbul.util")
local repository = require("fimbul.repository")

local cli = require('fimbul.ui.cli')

local optparser = std.optparse(
[[
fimbul-script 0.1 - Run scripts with preset environment of fimbul
Part of the fimbul project. Copyright (c) 2014 Florian Stinglmayr

Usage: fimbul-script [options] script

Options:

   -r --repository=DIR   Directory of the repository. Default: .
      --version          Version information.

Please report bugs to https://github.com/n0la/fimbul.
]])

local repo, r
local script

_G.arg, _G.opts = optparser:parse(_G.arg)

script = arg[1]
table.remove(arg, 1)

repo = cli.standard_args(_G.opts)
r = cli.open_repository(repo)

local s = io.open(script, "r")
-- Skip she-bang
s:read()
-- Read rest of script
local cnt = s:read("*all")
local func, e = load(cnt, script, 'bt')

if not func then
   io.stderr:write(e .. "\n")
   os.exit(3)
end

func()
