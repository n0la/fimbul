#!/usr/bin/env lua

local pretty = require('pl.pretty')
local std = require('std')

local util = require('fimbul.util')
local repository = require('fimbul.repository')

local cli = require('fimbul.ui.cli')

local optparser = std.optparse(
[[
fimbul-character 0.1

Part of the fimbul project. All rights reserved.

Usage: fimbul-character [options] [command]

The fimbul-character reads your character (PC or NPC) information from your
repository (or a file) and does all sorts of calculations for you.

Options:
  -r --repository=DIR   Alternate path to repository to use.
  -n --name=NAME        Name of the character

Commands:
  calculate         Calculate the character and show stats.
  list              List all characters

Please report bugs to https://github.com/n0la/fimbul
]])

local repo, r
local cmd

_G.arg, _G.opts = optparser:parse(_G.arg)

cmd = arg[1]
if cmd == nil then
   optparser:help()
   os.exit(1)
end
table.remove(arg, 1)

function char_calculate()
   local n = opts['name']

   if n == nil then
      io.stderr:write("No name specified.\n")
      return 3
   end

   local c = r:spawn_character(n)

   if c == nil then
      io.stderr:write("No such character: " .. name .. "\n")
      return 3
   end

   print(c:string(true))
end

function char_list()
   for _, i in pairs(r:engine():characters(r)) do
      print(i.name)
   end
end

local commands = {
   ['calculate'] = {handler = char_calculate},
   ['calc'] = {handler = char_calculate},
   ['list'] = {handler = char_list}
}

repo = cli.standard_args(_G.opts)
r = cli.open_repository(repo)

cli.dispatch_command(commands, cmd)
